{{ define "main" }}
<main class="grammar-container">

  <!-- 主体文章列 -->
  <article class="grammar-card">
      {{ $sectionName := "grammarpoints" }}
      {{ $levelName := .Title }}
      {{ $allPages := where .Site.RegularPages "Section" $sectionName }}
      {{ $levelPages := where $allPages "Params.grammarlevel" "eq" $levelName }}
  <header class="grammar-header">
      <h1 class="grammar-title">{{ .Title }} の文法一覧</h1>
      {{ if eq (len $levelPages) 0 }}
        <p>暂无该等级的语法点。</p>
      {{ else }}
       <p style="font-size: 18px;">该等级共有 <em><strong>{{ len $levelPages }}</strong></em> 条语法</p> 
        {{- if .Description }}
         <h5 class="grammar-description">
        {{ .Description }}
      </h5>
      {{- end }}
        {{ range $levelPages.ByDate.Reverse }}
          {{ partial "grammar-full-card.html" . }}
        {{ end }}
      {{ end }}
     
    </header>

    <div class="grammar-content">
      
      
      
      
    </div>

 </article>

  <!-- 右侧侧边栏 -->
  <aside class="sidebar right-sidebar">
    {{ partial "grammar-sidebar.html" . }}
  </aside>

</main>

<!-- 调用播放audio原生控件 -->
<audio id="globalAudioPlayer" controls preload="none" style="display: none;"></audio>

<!-- 播放器 JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const globalPlayer = document.getElementById('globalAudioPlayer');
  let currentPlayingBtn = null;

  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-src], .audio-play-btn, .grammar-audio-play-btn');
    if (!btn) return;

    e.preventDefault();
    const audioSrc = btn.dataset.src;
    if (!audioSrc) return;

    // 点击同一个按钮 => 播放/暂停切换
    if (currentPlayingBtn === btn) {
      if (globalPlayer.paused) {
        globalPlayer.play();
      } else {
        globalPlayer.pause();
      }
    } else {
      // 切换到新的音频
      if (currentPlayingBtn) currentPlayingBtn.classList.remove('playing');

      globalPlayer.src = audioSrc;
      globalPlayer.play();

      btn.classList.add('playing');
      currentPlayingBtn = btn;
    }
  });

  // 播放结束时重置状态
  globalPlayer.addEventListener('ended', () => {
    if (currentPlayingBtn) {
      currentPlayingBtn.classList.remove('playing');
      currentPlayingBtn = null;
    }
  });
});
</script>
{{ end }}
