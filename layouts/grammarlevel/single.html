{{ define "main" }}

<main class="grammar-container">

  <!-- 主体文章列 -->
  <article class="grammar-card">
  <header class="grammar-header">
      <h1 class="grammar-title">{{ .Title }} の文法一覧</h1>
      {{- if .Description }}
      <div class="grammar-content" style="font-size: 1rem; color: var(--secondary);">
        {{ .Description }}
      </div>
      {{- end }}
    </header>

    <div class="grammar-content">
      {{ $sectionName := "grammarpoints" }}
      {{ $levelName := .Title }}
      {{ $allPages := where .Site.RegularPages "Section" $sectionName }}
      {{ $levelPages := where $allPages "Params.grammarlevel" "eq" $levelName }}

      <p>当前 Section: {{ $sectionName }}</p>
      <p>当前 Title: {{ .Title }}</p>
      <p>匹配到的页面数量: {{ len $levelPages }}</p>
      
      {{ if eq (len $levelPages) 0 }}
        <p>暂无该等级的语法点。</p>
      {{ else }}
        {{ range $levelPages.ByDate.Reverse }}
          {{ .Title }}
        {{ end }}
      {{ end }}
    </div>
  {{ end }}

 </article>

  <!-- 右侧侧边栏 -->
  <aside class="sidebar right-sidebar">
    {{ partial "grammar-sidebar.html" . }}
  </aside>

</main>

<!-- 调用播放audio原生控件 -->
<audio id="globalAudioPlayer" controls preload="none" style="width:100%; max-width:320px; border-radius:10px;"></audio>

<!-- 播放器 JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const globalPlayer = document.getElementById('globalAudioPlayer');
  let currentPlayingBtn = null;

  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-src], .audio-play-btn, .grammar-audio-play-btn');
    if (!btn) return;

    e.preventDefault();
    const audioSrc = btn.dataset.src;
    if (!audioSrc) return;

    // 点击同一个按钮 => 播放/暂停切换
    if (currentPlayingBtn === btn) {
      if (globalPlayer.paused) {
        globalPlayer.play();
      } else {
        globalPlayer.pause();
      }
    } else {
      // 切换到新的音频
      if (currentPlayingBtn) currentPlayingBtn.classList.remove('playing');

      globalPlayer.src = audioSrc;
      globalPlayer.play();

      btn.classList.add('playing');
      currentPlayingBtn = btn;
    }
  });

  // 播放结束时重置状态
  globalPlayer.addEventListener('ended', () => {
    if (currentPlayingBtn) {
      currentPlayingBtn.classList.remove('playing');
      currentPlayingBtn = null;
    }
  });
});
</script>
