{{ define "main" }}
<main class="grammar-container">

  <article class="grammar-card">

    <!-- 显示标题与时间 -->
    <header class="grammar-header">
      <h1 class="grammar-title">{{ .Title }}</h1>
      {{ with .Date }}
        <time class="grammar-date" datetime="{{ .Format "2006-01-02" }}">{{ .Format "2006-01-02" }}</time>
      {{ end }} 
     <h5 class="grammar-description">毎週少しずつ、文法を身につけよう！</h5>
    </header>

  
   <div class="grammar-content">      
       <!-- 获取并调用完整卡片显示当天的语法点 -->
     {{ $currentDate := .Date }}
     {{ $Grammarpoints := where (where .Site.RegularPages "Section" "grammarpoints") "Date" "eq" $currentDate }}
       {{ $GrammarsortedPoints := $Grammarpoints.ByParam "level_sort" }}
      
       {{ range $GrammarsortedPoints }}
         {{ partial "grammar-full-card.html" . }}
       {{ else }}
         <p>暂无语法点</p>
       {{ end }}
   </div>

  </article>

  <!-- 右侧语法侧边栏，调用侧边栏目 -->
  <aside class="sidebar right-sidebar">
    {{ partial "grammar-sidebar.html" . }}
  </aside>

</main>

<!-- 共调用播放audio原生控件 -->
<audio id="globalAudioPlayer" controls preload="none" style="width:100%; max-width:320px; border-radius:10px;"></audio>

<!-- 播放器 JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const globalPlayer = document.getElementById('globalAudioPlayer');
  let currentPlayingBtn = null;

  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-src], .audio-play-btn, .grammar-audio-play-btn');
    if (!btn) return;

    e.preventDefault();
    const audioSrc = btn.dataset.src;
    if (!audioSrc) return;

    // 点击同一个按钮 => 播放/暂停切换
    if (currentPlayingBtn === btn) {
      if (globalPlayer.paused) {
        globalPlayer.play();
      } else {
        globalPlayer.pause();
      }
    } else {
      // 切换到新的音频
      if (currentPlayingBtn) currentPlayingBtn.classList.remove('playing');

      globalPlayer.src = audioSrc;
      globalPlayer.play();

      btn.classList.add('playing');
      currentPlayingBtn = btn;
    }
  });

  // 播放结束时重置状态
  globalPlayer.addEventListener('ended', () => {
    if (currentPlayingBtn) {
      currentPlayingBtn.classList.remove('playing');
      currentPlayingBtn = null;
    }
  });
});
</script>
{{ end }}